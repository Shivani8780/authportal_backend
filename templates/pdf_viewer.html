<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-        .page-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #FFFEF7;
            border: 3px solid #8B4513;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            padding: 10px;
            overflow: auto;
            cursor: grab;
            touch-action: pan-x pan-y pinch-zoom;
            -webkit-overflow-scrolling: touch;
        }scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>{{ ebooklet_name }} - PDF Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(139, 69, 19, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .btn {
            padding: 10px 20px;
            background: #D4AF37;
            color: #8B4513;
            border: 2px solid #8B4513;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn:hover:not(:disabled) {
            background: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #888;
            color: #ccc;
            border-color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .page-info {
            font-size: 16px;
            color: #FFD700;
            min-width: 150px;
            text-align: center;
            font-weight: 600;
            padding: 10px 20px;
            background: rgba(139, 69, 19, 0.8);
            border-radius: 8px;
            border: 2px solid #D4AF37;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .book-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 70px;
            margin-bottom: 20px;
            padding: 20px;
            perspective: 1000px;
            height: calc(100vh - 90px);
        }

        .book {
            position: relative;
            width: 90vw;
            max-width: 900px;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
            background: #8B4513;
        }

        .page-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #FFFEF7;
            border: 3px solid #8B4513;
            border-radius: 10px;
            padding: 10px;
            overflow: hidden;
            touch-action: none;
        }

        .page-container:active {
            cursor: grabbing;
        }

        /* Remove scrollbar styling since we're hiding overflow */
        /* Touch behavior optimization */
        .page-container {
            touch-action: pan-x pan-y;
            /* Allow panning for zoomed content */
        }

        .pdf-canvas {
            touch-action: none;
            /* Prevent default touch behaviors on canvas */
            position: relative;
            /* Performance optimizations for smooth rendering */
            will-change: auto;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            image-rendering: crisp-edges;
        }

        /* Prevent iOS bounce effect and default touch behaviors */
        body {
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        .page-container.flipping {
            transform: rotateY(-5deg);
        }

        .pdf-canvas {
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: grab;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            touch-action: none;
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .pdf-canvas:active {
            cursor: grabbing;
        }

        /* Navigation overlay */
        .nav-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 100;
        }

        .nav-btn {
            pointer-events: auto;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(139, 69, 19, 0.8);
            border: 3px solid #D4AF37;
            color: #FFD700;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            opacity: 0.7;
            margin: 0 15px;
        }

        .nav-btn:hover {
            opacity: 1;
            background: rgba(139, 69, 19, 0.9);
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .nav-btn svg {
            width: 32px;
            height: 32px;
            fill: currentColor;
        }

        .prev-btn {
            margin-left: 20px;
        }

        .next-btn {
            margin-right: 20px;
        }

        .page-flip-animation {
            animation: pageFlip 0.6s ease-in-out;
        }

        @keyframes pageFlip {
            0% {
                transform: rotateY(0deg);
            }

            50% {
                transform: rotateY(-90deg);
            }

            100% {
                transform: rotateY(0deg);
            }
        }

        /* Loading state */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(139, 69, 19, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(212, 175, 55, 0.3);
            border-top: 6px solid #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #FFD700;
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Error message */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #8B4513;
            color: #FFD700;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #D4AF37;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 80%;
            z-index: 3000;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .nav-bar {
                padding: 10px 15px;
                gap: 15px;
                min-height: 60px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 70px;
                gap: 5px;
            }

            .btn svg {
                width: 14px;
                height: 14px;
            }

            .page-info {
                font-size: 11px;
                padding: 8px 12px;
                min-width: 80px;
                text-align: center;
            }

            .book-container {
                margin-top: 75px;
                padding: 10px;
                height: calc(100vh - 90px);
            }

            .book {
                width: 100%;
                max-width: 100vw;
                height: 100%;
                margin: 0;
                border-radius: 8px;
            }

            .page-container {
                padding: 10px;
                border-radius: 8px;
                border: 2px solid #8B4513;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
            }

            .pdf-canvas {
                max-width: 100%;
                max-height: 100%;
                width: auto;
                height: auto;
                display: block;
                margin: 0 auto;
            }

            .nav-btn {
                width: 65px;
                height: 65px;
                margin: 0 15px;
            }

            .nav-btn svg {
                width: 30px;
                height: 30px;
            }
        }

        /* Small mobile screens */
        @media (max-width: 480px) {
            .nav-bar {
                padding: 8px 10px;
                gap: 10px;
                min-height: 55px;
            }

            .btn {
                padding: 6px 8px;
                font-size: 10px;
                min-width: 60px;
            }

            .btn svg {
                width: 12px;
                height: 12px;
            }

            .page-info {
                font-size: 10px;
                padding: 6px 8px;
                min-width: 70px;
            }

            .book-container {
                margin-top: 70px;
                padding: 5px;
                height: calc(100vh - 80px);
            }

            .book {
                border-radius: 5px;
            }
        }

        /* Disable printing */
        @media print {
            body * {
                display: none !important;
            }

            body:after {
                content: "Printing is not allowed";
                display: block !important;
                color: black;
                font-size: 24px;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading your book...</div>
        </div>
    </div>

    <div class="nav-bar">
        <div id="pageInfo" class="page-info">Page 1 of 1</div>
    </div>

    <div class="book-container">
        <div class="book">
            <!-- Single Page -->
            <div class="page-container" id="mainPage">
                <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
            </div>

            <!-- Navigation overlay buttons - positioned outside page container -->
            <div class="nav-overlay">
                <button class="nav-btn prev-btn" id="prevPageBtn" title="Previous Page">
                    <svg viewBox="0 0 24 24">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                    </svg>
                </button>
                <button class="nav-btn next-btn" id="nextPageBtn" title="Next Page">
                    <svg viewBox="0 0 24 24">
                        <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Screenshot Detection and Protection
        function initScreenshotProtection() {
            // Focus on reliable detection methods only
            document.addEventListener('keydown', function (e) {
                // Windows/Desktop: Print Screen (reliable)
                if (e.key === 'PrintScreen' || e.keyCode === 44) {
                    handleScreenshotAttempt('Print Screen');
                }

                // Desktop screenshot shortcuts (reliable)
                if ((e.metaKey || e.ctrlKey) && e.shiftKey && (e.key === 'S' || e.key === '3' || e.key === '4')) {
                    e.preventDefault();
                    handleScreenshotAttempt('Screenshot Shortcut');
                }

                // Developer tools shortcuts
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'J')) {
                    handleScreenshotAttempt('Developer Tools Shortcut');
                }

                // Prevent common screenshot shortcuts
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'S' || e.key === '3' || e.key === '4')) {
                    e.preventDefault();
                    handleScreenshotAttempt('Screenshot Shortcut');
                }
            });

            // 2. Detect visibility changes (screenshot apps often cause this)
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    // Page became hidden - possible screenshot
                    setTimeout(() => {
                        if (!document.hidden) {
                            handleScreenshotAttempt('Visibility Change');
                        }
                    }, 100);
                }
            });

            // 3. Detect window blur/focus changes
            let blurTime = 0;
            window.addEventListener('blur', function () {
                blurTime = Date.now();
            });

            window.addEventListener('focus', function () {
                if (blurTime > 0 && Date.now() - blurTime < 2000) {
                    handleScreenshotAttempt('Window Focus Change');
                }
                blurTime = 0;
            });

            // 4. Mobile-specific screenshot detection
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Detect rapid orientation changes (sometimes triggered by screenshot)
                let lastOrientation = screen.orientation ? screen.orientation.angle : window.orientation;
                window.addEventListener('orientationchange', function () {
                    setTimeout(() => {
                        const currentOrientation = screen.orientation ? screen.orientation.angle : window.orientation;
                        if (currentOrientation === lastOrientation) {
                            // Orientation event triggered but didn't actually change
                            handleScreenshotAttempt('Orientation Event');
                        }
                        lastOrientation = currentOrientation;
                    }, 500);
                });

                // Detect touch pattern that might indicate screenshot gesture
                let touchStartTime = 0;
                let touchCount = 0;
                let isPinchZooming = false;
                let lastPinchDistance = 0;

                document.addEventListener('touchstart', function (e) {
                    const now = Date.now();
                    touchCount = e.touches.length;

                    // Reset pinch detection
                    isPinchZooming = false;

                    // If 2 touches, check if it's a pinch gesture
                    if (touchCount === 2) {
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const dx = touch1.clientX - touch2.clientX;
                        const dy = touch1.clientY - touch2.clientY;
                        lastPinchDistance = Math.sqrt(dx * dx + dy * dy);
                        isPinchZooming = true; // Assume it's pinch zoom until proven otherwise
                    }
                });

                // Monitor touch movement to confirm pinch vs screenshot
                document.addEventListener('touchmove', function (e) {
                    if (e.touches.length === 2 && isPinchZooming) {
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const dx = touch1.clientX - touch2.clientX;
                        const dy = touch1.clientY - touch2.clientY;
                        const currentDistance = Math.sqrt(dx * dx + dy * dy);

                        // If distance is changing significantly, it's definitely pinch zoom
                        if (Math.abs(currentDistance - lastPinchDistance) > 10) {
                            isPinchZooming = true; // Confirmed pinch zoom
                        }
                    }
                });

                // Detect end of touch - if 2 fingers but no pinch movement, might be screenshot
                document.addEventListener('touchend', function (e) {
                    if (e.touches.length === 0 && touchCount === 2 && !isPinchZooming) {
                        // 2 fingers touched but no pinch movement - possible screenshot
                        const touchDuration = Date.now() - touchStartTime;
                        if (touchDuration < 500) { // Quick 2-finger tap
                            handleScreenshotAttempt('Two-finger Screenshot Gesture');
                        }
                    }

                    if (e.touches.length === 0) {
                        isPinchZooming = false;
                        touchCount = 0;
                    }
                });
            }

            // 5. Detect Developer Tools opening
            let devtools = { open: false, orientation: null };
            setInterval(function () {
                if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
                    if (!devtools.open) {
                        devtools.open = true;
                        handleScreenshotAttempt('Developer Tools');
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
        }

        // Handle screenshot attempt detection
        function handleScreenshotAttempt(method) {
            if (!isProtectionActive) return;

            screenshotAttempts++;
            console.warn(`Screenshot attempt detected via: ${method}`);

            // Show warning overlay
            showScreenshotWarning(method);

            // Temporarily hide PDF content
            const pageContainer = document.getElementById('mainPage');
            if (pageContainer) {
                pageContainer.style.opacity = '0';
                pageContainer.style.filter = 'blur(20px)';

                setTimeout(() => {
                    pageContainer.style.opacity = '1';
                    pageContainer.style.filter = 'none';
                }, 1000);
            }

            // Log attempt (you can send this to your backend)
            logScreenshotAttempt(method);
        }

        // Show screenshot warning overlay
        function showScreenshotWarning(method) {
            // Remove existing warning if any
            const existingWarning = document.getElementById('screenshotWarning');
            if (existingWarning) {
                existingWarning.remove();
            }

            // Create warning overlay
            const warning = document.createElement('div');
            warning.id = 'screenshotWarning';
            warning.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(139, 69, 19, 0.95);
                    z-index: 10000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    flex-direction: column;
                    color: #FFD700;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                ">
                    <div style="
                        background: rgba(0, 0, 0, 0.8);
                        padding: 30px;
                        border-radius: 15px;
                        text-align: center;
                        border: 3px solid #D4AF37;
                        max-width: 90%;
                    ">
                        <h2 style="color: #FF6B6B; margin-bottom: 20px; font-size: 24px;">⚠️ Screenshot Detected!</h2>
                        <p style="font-size: 18px; margin-bottom: 15px;">Taking screenshots is not allowed for this content.</p>
                        <p style="font-size: 14px; color: #FFA500; margin-bottom: 20px;">Method detected: ${method}</p>
                        <p style="font-size: 16px; margin-bottom: 25px;">This attempt has been logged for security purposes.</p>
                        <button onclick="closeScreenshotWarning()" style="
                            background: #D4AF37;
                            color: #8B4513;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">I Understand</button>
                    </div>
                </div>
            `;

            document.body.appendChild(warning);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                closeScreenshotWarning();
            }, 5000);
        }

        // Close screenshot warning
        function closeScreenshotWarning() {
            const warning = document.getElementById('screenshotWarning');
            if (warning) {
                warning.style.opacity = '0';
                setTimeout(() => {
                    warning.remove();
                }, 300);
            }
        }

        // Log screenshot attempt to backend (you can implement this)
        function logScreenshotAttempt(method) {
            const logData = {
                timestamp: new Date().toISOString(),
                method: method,
                userAgent: navigator.userAgent,
                url: window.location.href,
                attemptNumber: screenshotAttempts
            };

            // You can send this to your Django backend
            // fetch('/api/log-screenshot-attempt/', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'X-CSRFToken': getCookie('csrftoken')
            //     },
            //     body: JSON.stringify(logData)
            // });

            console.log('Screenshot attempt logged:', logData);
        }

        // Additional Content Protection
        function addContentProtection() {
            // Disable right-click context menu
            document.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                handleScreenshotAttempt('Right Click');
                return false;
            });

            // Disable text selection
            document.addEventListener('selectstart', function (e) {
                e.preventDefault();
                return false;
            });

            // Disable drag and drop
            document.addEventListener('dragstart', function (e) {
                e.preventDefault();
                return false;
            });

            // Prevent image dragging specifically
            document.addEventListener('dragstart', function (e) {
                if (e.target.tagName === 'IMG' || e.target.tagName === 'CANVAS') {
                    e.preventDefault();
                    return false;
                }
            });

            // Add CSS to prevent text selection and disable certain features
            const style = document.createElement('style');
            style.textContent = `
                * {
                    -webkit-user-select: none !important;
                    -moz-user-select: none !important;
                    -ms-user-select: none !important;
                    user-select: none !important;
                    -webkit-touch-callout: none !important;
                    -webkit-tap-highlight-color: transparent !important;
                }
                
                canvas {
                    pointer-events: auto !important;
                    -webkit-user-drag: none !important;
                    -khtml-user-drag: none !important;
                    -moz-user-drag: none !important;
                    -o-user-drag: none !important;
                    user-drag: none !important;
                }

                /* Prevent screenshot on iOS Safari */
                @media screen and (-webkit-min-device-pixel-ratio: 0) {
                    canvas {
                        -webkit-appearance: none !important;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        // Detect mobile device and set appropriate initial scale
        const isMobile = window.innerWidth <= 768;
        let currentScale = isMobile ? 1.2 : 1.5;
        let minScale = 0.5;
        let maxScale = 8.0; // Increased for better text readability on mobile
        let navigationLocked = false;
        let currentRenderTask = null;

        // Canvas positioning for pan/drag
        let canvasOffsetX = 0;
        let canvasOffsetY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let startOffsetX = 0;
        let startOffsetY = 0;

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');
        const pageContainer = document.getElementById('mainPage');

        async function renderPage(num, showAnimation = true) {
            // Simple render without complex error handling
            if (pageRendering) {
                pageNumPending = num;
                return;
            }

            pageRendering = true;
            document.getElementById('loading').style.display = 'flex';

            try {
                const page = await pdfDoc.getPage(num);
                // Use base scale for canvas rendering, container will handle zoom
                const baseScale = 2.0; // High resolution for crisp rendering
                const viewport = page.getViewport({ scale: baseScale });

                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.width = '100%';
                canvas.style.height = 'auto';

                // Apply zoom to the entire container
                updateContainerZoom();

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                if (showAnimation) {
                    document.getElementById('mainPage').classList.add('page-flip-animation');
                }

                await page.render(renderContext).promise;

                // Update page info
                document.getElementById('pageInfo').textContent = `Page ${num} of ${pdfDoc.numPages}`;

                // Update navigation button states
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');

                prevBtn.disabled = num <= 1;
                nextBtn.disabled = num >= pdfDoc.numPages;

                // Hide navigation if only one page
                const navOverlay = document.querySelector('.nav-overlay');
                if (pdfDoc.numPages <= 1) {
                    navOverlay.style.display = 'none';
                } else {
                    navOverlay.style.display = 'flex';
                }

                if (showAnimation) {
                    setTimeout(() => {
                        document.getElementById('mainPage').classList.remove('page-flip-animation');
                    }, 600);
                }

                pageRendering = false;
                document.getElementById('loading').style.display = 'none';

                if (pageNumPending !== null) {
                    const pending = pageNumPending;
                    pageNumPending = null;
                    renderPage(pending, showAnimation);
                }
            } catch (error) {
                console.error('Error rendering page:', error);
                document.getElementById('errorMessage').textContent = `Error rendering page ${num}. Please try again.`;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                pageRendering = false;
            }
        }

        // Quiet render for zoom operations - no loading screen
        async function renderPageQuiet(num) {
            if (pageRendering) return;

            pageRendering = true;

            try {
                const page = await pdfDoc.getPage(num);
                const baseScale = 2.0; // High resolution for crisp rendering
                const viewport = page.getViewport({ scale: baseScale });

                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.width = '100%';
                canvas.style.height = 'auto';

                // Apply zoom to the entire container
                updateContainerZoom();

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                pageRendering = false;
            } catch (error) {
                console.error('Error in quiet render:', error);
                pageRendering = false;
            }
        }

        // Performance optimization variables
        let transformUpdateId = null;
        let lastTransformTime = 0;
        const TRANSFORM_THROTTLE = 16; // ~60fps

        function updateContainerZoom(immediate = false) {
            // Throttle transform updates for smooth performance
            const now = Date.now();
            if (!immediate && now - lastTransformTime < TRANSFORM_THROTTLE) {
                if (transformUpdateId) return;

                transformUpdateId = requestAnimationFrame(() => {
                    updateContainerZoomImmediate();
                    transformUpdateId = null;
                    lastTransformTime = Date.now();
                });
                return;
            }

            updateContainerZoomImmediate();
            lastTransformTime = now;
        }

        function updateContainerZoomImmediate() {
            // Reset pan offset when zoomed out to ensure proper centering
            let offsetX = canvasOffsetX;
            let offsetY = canvasOffsetY;

            // Aggressive centering for zoom out scenarios
            if (currentScale <= 1.0) {
                // Completely center when at or below 100% zoom
                offsetX = 0;
                offsetY = 0;
                canvasOffsetX = 0;
                canvasOffsetY = 0;
            } else if (currentScale <= 1.3) {
                // Gradually reduce offsets as we zoom out from 130% to 100%
                const centeringFactor = (currentScale - 1.0) / 0.3; // 0 to 1 scale
                offsetX = canvasOffsetX * centeringFactor;
                offsetY = canvasOffsetY * centeringFactor;

                // Update the actual offset values for consistency
                canvasOffsetX = offsetX;
                canvasOffsetY = offsetY;
            }

            // Apply transform to canvas with translation from center
            const transform = `translate(-50%, -50%) translate3d(${offsetX}px, ${offsetY}px, 0) scale(${currentScale})`;
            canvas.style.transform = transform;

            // Force hardware acceleration on canvas
            canvas.style.willChange = currentScale > 1.0 ? 'transform' : 'auto';
        }

        function queueRenderPage(num, showAnimation = true) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num, showAnimation);
            }
        }

        function onPrevPage() {
            if (navigationLocked) return;
            console.log('onPrevPage called, current page:', pageNum);
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        function onNextPage() {
            if (navigationLocked) return;
            console.log('onNextPage called, current page:', pageNum);
            if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }

        function updateZoomInfo() {
            const zoomPercent = Math.round(currentScale * 100);
            console.log(`Current zoom: ${zoomPercent}%`);
        }

        function zoomIn() {
            if (currentScale < maxScale && !navigationLocked) {
                navigationLocked = true;
                currentScale = Math.min(maxScale, currentScale + 0.2);
                updateZoomInfo();
                updateContainerZoom(true); // Use immediate update for zoom buttons
                setTimeout(() => { navigationLocked = false; }, 200);
            }
        }

        function zoomOut() {
            if (currentScale > minScale && !navigationLocked) {
                navigationLocked = true;
                const previousScale = currentScale;
                currentScale = Math.max(minScale, currentScale - 0.2);

                // Force immediate centering when zooming out to prevent off-center display
                if (currentScale <= 1.0) {
                    canvasOffsetX = 0;
                    canvasOffsetY = 0;
                }

                updateZoomInfo();
                updateContainerZoom(true); // Use immediate update for zoom buttons
                setTimeout(() => { navigationLocked = false; }, 200);
            }
        }

        function resetZoom() {
            if (!navigationLocked) {
                navigationLocked = true;
                currentScale = 1.0;
                canvasOffsetX = 0;
                canvasOffsetY = 0;
                updateZoomInfo();
                updateContainerZoom();
                setTimeout(() => { navigationLocked = false; }, 200);
            }
        }

        async function initPDF() {
            try {
                document.getElementById('loading').style.display = 'flex';
                const pdfUrl = "{% load static %}{% static 'pdfs/' %}{{ pdf_filename }}";
                pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;

                // Initial page render (no animation)
                renderPage(pageNum, false);

                // Add navigation button event listeners
                document.getElementById('prevPageBtn').addEventListener('click', onPrevPage);
                document.getElementById('nextPageBtn').addEventListener('click', onNextPage);

                // Initialize zoom info
                updateZoomInfo();

                // Mouse drag for panning when zoomed
                canvas.addEventListener('mousedown', (e) => {
                    if (currentScale > 1.0) { // Only allow dragging when zoomed
                        isDragging = true;
                        dragStartX = e.clientX;
                        dragStartY = e.clientY;
                        startOffsetX = canvasOffsetX;
                        startOffsetY = canvasOffsetY;
                        canvas.style.cursor = 'grabbing';
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging && currentScale > 1.0) {
                        const deltaX = e.clientX - dragStartX;
                        const deltaY = e.clientY - dragStartY;
                        canvasOffsetX = startOffsetX + deltaX;
                        canvasOffsetY = startOffsetY + deltaY;
                        updateContainerZoom(); // Use throttled version for smooth panning
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    canvas.style.cursor = currentScale > 1.0 ? 'grab' : 'default';
                });

                // Keyboard navigation - ONLY for buttons, no scroll
                document.addEventListener('keydown', (e) => {
                    if (!navigationLocked) {
                        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                            e.preventDefault();
                            onPrevPage();
                        }
                        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                            e.preventDefault();
                            onNextPage();
                        }
                        if (e.key === 'Home') {
                            e.preventDefault();
                            pageNum = 1;
                            renderPage(pageNum);
                        }
                        if (e.key === 'End' && pdfDoc) {
                            e.preventDefault();
                            pageNum = pdfDoc.numPages;
                            renderPage(pageNum);
                        }
                    }
                    // Zoom controls
                    if (e.key === '+' || e.key === '=') {
                        e.preventDefault();
                        zoomIn();
                    }
                    if (e.key === '-' || e.key === '_') {
                        e.preventDefault();
                        zoomOut();
                    }
                    if (e.key === '0') {
                        e.preventDefault();
                        resetZoom();
                    }
                });

                // Touch handling - simple drag for panning, buttons for navigation
                let touchStartX = 0;
                let touchStartY = 0;
                let touchStartOffsetX = 0;
                let touchStartOffsetY = 0;
                let initialDistance = 0;
                let lastScale = currentScale;
                let isPinching = false;
                let touchMoved = false;
                let lastPinchRender = 0;

                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        // Single touch - prepare for potential drag
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        touchStartOffsetX = canvasOffsetX;
                        touchStartOffsetY = canvasOffsetY;
                        isPinching = false;
                        touchMoved = false;
                    } else if (e.touches.length === 2) {
                        // Two touches - pinch zoom only
                        e.preventDefault();
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        initialDistance = Math.sqrt(dx * dx + dy * dy);
                        lastScale = currentScale;
                        isPinching = true;
                        touchMoved = false;
                        lastPinchRender = Date.now();
                    }
                });

                document.addEventListener('touchmove', (e) => {
                    touchMoved = true;

                    if (e.touches.length === 2 && isPinching) {
                        // Pinch zoom - update scale and container transform
                        e.preventDefault();
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (initialDistance > 0) {
                            const scaleFactor = distance / initialDistance;
                            const newScale = lastScale * scaleFactor;
                            const clampedScale = Math.max(minScale, Math.min(maxScale, newScale));

                            currentScale = clampedScale;
                            updateZoomInfo();
                            updateContainerZoom(); // Throttled for smooth pinch zoom
                        }
                    } else if (e.touches.length === 1 && !isPinching && currentScale > 1.0) {
                        // Single touch drag when zoomed - optimized for smooth panning
                        const deltaX = e.touches[0].clientX - touchStartX;
                        const deltaY = e.touches[0].clientY - touchStartY;
                        canvasOffsetX = touchStartOffsetX + deltaX;
                        canvasOffsetY = touchStartOffsetY + deltaY;
                        updateContainerZoom(); // Throttled for smooth touch panning
                    }
                }, { passive: false });

                document.addEventListener('touchend', (e) => {
                    if (e.touches.length === 0) {
                        // Handle tap navigation (only if not pinching/dragging and scale is normal)
                        if (!touchMoved && !isPinching && currentScale <= 1.5 && pdfDoc && pdfDoc.numPages > 1) {
                            const touch = e.changedTouches[0];
                            const rect = canvas.getBoundingClientRect();
                            const x = touch.clientX - rect.left;
                            const canvasWidth = rect.width;

                            // Left third of canvas = previous page
                            if (x < canvasWidth / 3 && pageNum > 1) {
                                onPrevPage();
                            }
                            // Right third of canvas = next page
                            else if (x > (canvasWidth * 2) / 3 && pageNum < pdfDoc.numPages) {
                                onNextPage();
                            }
                        }

                        isPinching = false;
                        touchMoved = false;
                        initialDistance = 0;
                    }
                });

                // Remove mouse wheel navigation - zoom only
                document.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    if (e.ctrlKey || e.metaKey) {
                        // Zoom with Ctrl+scroll
                        if (e.deltaY < 0) zoomIn();
                        else zoomOut();
                    }
                    // Remove page navigation on scroll
                }, { passive: false });
            } catch (error) {
                console.error('Error loading PDF:', error);
                console.error('PDF URL:', `/api/ebooklet/{{ ebooklet_id }}/pdf/`);
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                document.getElementById('errorMessage').textContent = `Error loading PDF: ${error.message}. Please check your connection and try again.`;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Handle window resize for mobile orientation changes
        let resizeTimeout;
        window.addEventListener('resize', () => {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(() => {
                if (pdfDoc && !pageRendering) {
                    renderPage(pageNum, false);
                }
            }, 250); // Wait for resize to complete
        });

        // Start loading the PDF
        initPDF();
    </script>
</body>

</html>