<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ ebooklet_name }} - PDF Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }

        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(139, 69, 19, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .btn {
            padding: 10px 20px;
            background: #D4AF37;
            color: #8B4513;
            border: 2px solid #8B4513;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn:hover:not(:disabled) {
            background: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #888;
            color: #ccc;
            border-color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .page-info {
            font-size: 16px;
            color: #FFD700;
            min-width: 150px;
            text-align: center;
            font-weight: 600;
            padding: 10px 20px;
            background: rgba(139, 69, 19, 0.8);
            border-radius: 8px;
            border: 2px solid #D4AF37;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .book-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 70px;
            margin-bottom: 20px;
            padding: 20px;
            perspective: 1000px;
            height: calc(100vh - 90px);
        }

        .book {
            position: relative;
            width: 90vw;
            max-width: 900px;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            display: flex;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
            background: #8B4513;
        }

        .page-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #FFFEF7;
            border: 3px solid #8B4513;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            padding: 10px;
            overflow: hidden;
            /* Hide scrollbars */
            cursor: grab;
        }

        .page-container:active {
            cursor: grabbing;
        }

        /* Remove scrollbar styling since we're hiding overflow */
        /* Touch behavior optimization */
        .page-container {
            touch-action: pan-x pan-y;
            /* Allow panning for zoomed content */
        }

        .pdf-canvas {
            touch-action: none;
            /* Prevent default touch behaviors on canvas */
            position: relative;
            transition: transform 0.1s ease-out;
        }

        /* Prevent iOS bounce effect and default touch behaviors */
        body {
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        .page-container.flipping {
            transform: rotateY(-5deg);
        }

        .pdf-canvas {
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            cursor: grab;
            display: block;
            max-width: none;
            /* Allow canvas to exceed container width when zoomed */
            max-height: none;
            /* Allow canvas to exceed container height when zoomed */
            width: auto;
            height: auto;
        }

        .pdf-canvas:active {
            cursor: grabbing;
        }

        .page-flip-animation {
            animation: pageFlip 0.6s ease-in-out;
        }

        @keyframes pageFlip {
            0% {
                transform: rotateY(0deg);
            }

            50% {
                transform: rotateY(-90deg);
            }

            100% {
                transform: rotateY(0deg);
            }
        }

        .nav-buttons {
            position: fixed;
            bottom: 24px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            z-index: 2000;
            pointer-events: none;
        }
        .nav-buttons .nav-button {
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }

        .nav-left, .nav-right {
            position: static;
            left: unset;
            right: unset;
            top: unset;
            transform: none;
        }

        .nav-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.9);
            border: 3px solid #8B4513;
            color: #8B4513;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin: 0 8px;
        }

        .nav-button:hover:not(:disabled) {
            background: #FFD700;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .nav-button:disabled {
            background: #888;
            color: #ccc;
            border-color: #888;
            cursor: not-allowed;
            transform: none;
        }

        .nav-button svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Loading state */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(139, 69, 19, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(212, 175, 55, 0.3);
            border-top: 6px solid #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #FFD700;
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Error message */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #8B4513;
            color: #FFD700;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #D4AF37;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 80%;
            z-index: 3000;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .nav-bar {
                padding: 8px 5px;
                flex-wrap: nowrap;
                gap: 20px;
                flex-direction: row;
                align-items: center;
                justify-content: center;
            }

            .nav-bar > * {
                margin-bottom: 6px;
            }

            .btn, .page-info {
                width: 100%;
                min-width: 0;
                max-width: 100%;
                box-sizing: border-box;
                font-size: 15px;
                padding: 12px 0;
                margin: 0;
            }

            .btn svg {
                width: 22px;
                height: 22px;
            }

            .page-info {
                font-size: 13px;
                padding: 10px 0;
                margin-bottom: 0;
            }

            .book-container {
                margin-top: 70px;
                padding: 5px;
                height: calc(100vh - 85px);
            }

            .book {
                width: 100vw;
                height: calc(100vh - 130px);
                max-height: calc(100vh - 130px);
                margin: 0;
                border-radius: 0;
            }

            .page-container {
                padding: 5px;
                border-radius: 0;
                border-left: none;
                border-right: none;
                overflow: hidden;
                /* Keep hidden on mobile too */
                align-items: center;
                justify-content: center;
            }

            .pdf-canvas {
                max-width: none;
                /* Allow canvas to be larger than container for zoom */
                max-height: none;
                /* Allow canvas to be larger than container for zoom */
                width: auto !important;
                height: auto !important;
                min-width: auto;
                /* Remove minimum width constraint */
            }

            .nav-buttons {
                position: fixed;
                bottom: 20px;
                z-index: 1000;
                width: 100vw;
                left: 0;
                right: 0;
                display: flex;
                justify-content: space-between;
                padding: 0 10px;
            }

            .nav-left {
                left: 20px;
                top: auto;
                transform: none;
            }

            /* Bottom nav buttons: left and right alignment */
            .nav-buttons {
                position: fixed;
                bottom: 24px;
                left: 0;
                right: 0;
                width: 100vw;
                display: flex;
                justify-content: space-between;
                align-items: center;
                z-index: 2000;
                pointer-events: none;
                padding: 0 24px;
                box-sizing: border-box;
            }
            .nav-buttons .nav-button {
                pointer-events: auto;
                box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            }
            .nav-left {
                justify-content: flex-start;
                flex: 1;
                display: flex;
            }
            .nav-right {
                justify-content: flex-end;
                flex: 1;
                display: flex;
            }
              
            }

            .book {
                width: 95vw;
                max-width: 800px;
            }

            .nav-button {
                width: 55px;
                height: 55px;
            }

        /* Disable printing */
        @media print {
            body * {
                display: none !important;
            }

            body:after {
                content: "Printing is not allowed";
                display: block !important;
                color: black;
                font-size: 24px;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading your book...</div>
        </div>
    </div>

    <div class="nav-bar">
        <button id="prevBtn" class="btn" disabled>
            <svg viewBox="0 0 24 24">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
            </svg>
            Previous Page
        </button>

        <button id="zoomOutBtn" class="btn">
            <svg viewBox="0 0 24 24">
                <path
                    d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                <path d="M7 9h5v1H7z" />
            </svg>
            Zoom Out
        </button>

        <div id="zoomInfo" class="page-info">100%</div>

        <button id="zoomInBtn" class="btn">
            <svg viewBox="0 0 24 24">
                <path
                    d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                <path d="M7 9h2.5v2.5h1V11H13V9h-2.5V6.5h-1V9H7z" />
            </svg>
            Zoom In
        </button>

        <div id="pageInfo" class="page-info">Page 1 of 1</div>

        <button id="nextBtn" class="btn" disabled>
            Next Page
            <svg viewBox="0 0 24 24">
                <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z" />
            </svg>
        </button>
    </div>

    <div class="book-container">
        <div class="book">
            <!-- Single Page -->
            <div class="page-container" id="mainPage">
                <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
            </div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons nav-left">
                <button class="nav-button" id="leftNavBtn" disabled>
                    <svg viewBox="0 0 24 24">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                    </svg>
                </button>
            </div>

            <div class="nav-buttons nav-right">
                <button class="nav-button" id="rightNavBtn" disabled>
                    <svg viewBox="0 0 24 24">
                        <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        // let currentScale = window.innerWidth <= 768 ? 1.0 : 1.5;
        let currentScale = 0.75;
        let minScale = 0.5;
        let maxScale = 5.0;
        let navigationLocked = false;
        let currentRenderTask = null;

        // Canvas positioning for pan/drag
        let canvasOffsetX = 0;
        let canvasOffsetY = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let startOffsetX = 0;
        let startOffsetY = 0;

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        async function renderPage(num, showAnimation = true) {
            // Simple render without complex error handling
            if (pageRendering) {
                pageNumPending = num;
                return;
            }

            pageRendering = true;
            document.getElementById('loading').style.display = 'flex';

            try {
                const page = await pdfDoc.getPage(num);
                const viewport = page.getViewport({ scale: currentScale });

                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';

                // Reset canvas position when changing pages or zoom
                updateCanvasPosition();

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                if (showAnimation) {
                    document.getElementById('mainPage').classList.add('page-flip-animation');
                }

                await page.render(renderContext).promise;

                // Update page info
                document.getElementById('pageInfo').textContent = `Page ${num} of ${pdfDoc.numPages}`;

                // Update button states
                document.getElementById('prevBtn').disabled = num <= 1;
                document.getElementById('leftNavBtn').disabled = num <= 1;
                document.getElementById('nextBtn').disabled = num >= pdfDoc.numPages;
                document.getElementById('rightNavBtn').disabled = num >= pdfDoc.numPages;

                if (showAnimation) {
                    setTimeout(() => {
                        document.getElementById('mainPage').classList.remove('page-flip-animation');
                    }, 600);
                }

                pageRendering = false;
                document.getElementById('loading').style.display = 'none';

                if (pageNumPending !== null) {
                    const pending = pageNumPending;
                    pageNumPending = null;
                    renderPage(pending, showAnimation);
                }
            } catch (error) {
                console.error('Error rendering page:', error);
                document.getElementById('errorMessage').textContent = `Error rendering page ${num}. Please try again.`;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                pageRendering = false;
            }
        }

        // Quiet render for zoom operations - no loading screen
        async function renderPageQuiet(num) {
            if (pageRendering) return;

            pageRendering = true;

            try {
                const page = await pdfDoc.getPage(num);
                const viewport = page.getViewport({ scale: currentScale });

                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';

                updateCanvasPosition();

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                pageRendering = false;
            } catch (error) {
                console.error('Error in quiet render:', error);
                pageRendering = false;
            }
        }

        function updateCanvasPosition() {
            canvas.style.transform = `translate(${canvasOffsetX}px, ${canvasOffsetY}px)`;
        }

        function queueRenderPage(num, showAnimation = true) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num, showAnimation);
            }
        }

        function onPrevPage() {
            if (navigationLocked) return;
            console.log('onPrevPage called, current page:', pageNum);
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        }

        function onNextPage() {
            if (navigationLocked) return;
            console.log('onNextPage called, current page:', pageNum);
            if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        }

        function updateZoomInfo() {
            const zoomPercent = Math.round(currentScale * 100);
            document.getElementById('zoomInfo').textContent = `${zoomPercent}%`;
        }

        function zoomIn() {
            if (currentScale < maxScale && !navigationLocked) {
                navigationLocked = true;
                currentScale = Math.min(maxScale, currentScale + 0.25);
                updateZoomInfo();
                // Reset canvas position when zooming
                canvasOffsetX = 0;
                canvasOffsetY = 0;
                renderPageQuiet(pageNum); // Use quiet render for button zoom
                setTimeout(() => { navigationLocked = false; }, 300);
            }
        }

        function zoomOut() {
            if (currentScale > minScale && !navigationLocked) {
                navigationLocked = true;
                currentScale = Math.max(minScale, currentScale - 0.25);
                updateZoomInfo();
                // Reset canvas position when zooming
                canvasOffsetX = 0;
                canvasOffsetY = 0;
                renderPageQuiet(pageNum); // Use quiet render for button zoom
                setTimeout(() => { navigationLocked = false; }, 300);
            }
        }

        function resetZoom() {
            if (!navigationLocked) {
                navigationLocked = true;
                currentScale = window.innerWidth <= 768 ? 1.0 : 1.5;
                updateZoomInfo();
                // Reset canvas position
                canvasOffsetX = 0;
                canvasOffsetY = 0;
                renderPageQuiet(pageNum); // Use quiet render for reset zoom
                setTimeout(() => { navigationLocked = false; }, 300);
            }
        }

        async function initPDF() {
            try {
                document.getElementById('loading').style.display = 'flex';
                const pdfUrl = `/api/ebooklet/{{ ebooklet_id }}/pdf/`;
                pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;

                // Initial page render (no animation)
                renderPage(pageNum, false);

                // Event listeners for top navigation
                document.getElementById('prevBtn').addEventListener('click', onPrevPage);
                document.getElementById('nextBtn').addEventListener('click', onNextPage);

                // Event listeners for side navigation
                document.getElementById('leftNavBtn').addEventListener('click', onPrevPage);
                document.getElementById('rightNavBtn').addEventListener('click', onNextPage);

                // Event listeners for zoom controls
                document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
                document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
                document.getElementById('zoomInfo').addEventListener('click', resetZoom);

                // Initialize zoom info
                updateZoomInfo();

                // Mouse drag for panning when zoomed
                canvas.addEventListener('mousedown', (e) => {
                    if (currentScale > 1.0) { // Only allow dragging when zoomed
                        isDragging = true;
                        dragStartX = e.clientX;
                        dragStartY = e.clientY;
                        startOffsetX = canvasOffsetX;
                        startOffsetY = canvasOffsetY;
                        canvas.style.cursor = 'grabbing';
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging && currentScale > 1.0) {
                        const deltaX = e.clientX - dragStartX;
                        const deltaY = e.clientY - dragStartY;
                        canvasOffsetX = startOffsetX + deltaX;
                        canvasOffsetY = startOffsetY + deltaY;
                        updateCanvasPosition();
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    canvas.style.cursor = currentScale > 1.0 ? 'grab' : 'default';
                });

                // Keyboard navigation - ONLY for buttons, no scroll
                document.addEventListener('keydown', (e) => {
                    if (!navigationLocked) {
                        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                            e.preventDefault();
                            onPrevPage();
                        }
                        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                            e.preventDefault();
                            onNextPage();
                        }
                        if (e.key === 'Home') {
                            e.preventDefault();
                            pageNum = 1;
                            renderPage(pageNum);
                        }
                        if (e.key === 'End' && pdfDoc) {
                            e.preventDefault();
                            pageNum = pdfDoc.numPages;
                            renderPage(pageNum);
                        }
                    }
                    // Zoom controls
                    if (e.key === '+' || e.key === '=') {
                        e.preventDefault();
                        zoomIn();
                    }
                    if (e.key === '-' || e.key === '_') {
                        e.preventDefault();
                        zoomOut();
                    }
                    if (e.key === '0') {
                        e.preventDefault();
                        resetZoom();
                    }
                });

                // Touch handling - simple drag for panning, buttons for navigation
                let touchStartX = 0;
                let touchStartY = 0;
                let touchStartOffsetX = 0;
                let touchStartOffsetY = 0;
                let initialDistance = 0;
                let lastScale = currentScale;
                let isPinching = false;
                let touchMoved = false;
                let lastPinchRender = 0;

                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        // Single touch - prepare for potential drag
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        touchStartOffsetX = canvasOffsetX;
                        touchStartOffsetY = canvasOffsetY;
                        isPinching = false;
                        touchMoved = false;
                    } else if (e.touches.length === 2) {
                        // Two touches - pinch zoom only
                        e.preventDefault();
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        initialDistance = Math.sqrt(dx * dx + dy * dy);
                        lastScale = currentScale;
                        isPinching = true;
                        touchMoved = false;
                        lastPinchRender = Date.now();
                    }
                });

                document.addEventListener('touchmove', (e) => {
                    touchMoved = true;

                    if (e.touches.length === 2 && isPinching) {
                        // Pinch zoom - update scale but don't render immediately
                        e.preventDefault();
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (initialDistance > 0 && Math.abs(distance - initialDistance) > 10) {
                            const scaleFactor = distance / initialDistance;
                            const newScale = lastScale * scaleFactor;
                            const clampedScale = Math.max(minScale, Math.min(maxScale, newScale));

                            if (Math.abs(clampedScale - currentScale) > 0.1) {
                                currentScale = clampedScale;
                                updateZoomInfo();

                                // Only render if enough time has passed to avoid constant loading
                                const now = Date.now();
                                if (now - lastPinchRender > 300) { // Render at most every 300ms
                                    lastPinchRender = now;
                                    canvasOffsetX = 0;
                                    canvasOffsetY = 0;

                                    // Use a timeout to render without showing loading
                                    setTimeout(() => {
                                        if (!pageRendering) {
                                            renderPageQuiet(pageNum);
                                        }
                                    }, 50);
                                }
                            }
                        }
                    } else if (e.touches.length === 1 && !isPinching && currentScale > 1.0) {
                        // Single touch drag when zoomed
                        const deltaX = e.touches[0].clientX - touchStartX;
                        const deltaY = e.touches[0].clientY - touchStartY;
                        canvasOffsetX = touchStartOffsetX + deltaX;
                        canvasOffsetY = touchStartOffsetY + deltaY;
                        updateCanvasPosition();
                    }
                }, { passive: false });

                document.addEventListener('touchend', (e) => {
                    if (e.touches.length === 0) {
                        // Final render when pinch ends
                        if (isPinching) {
                            setTimeout(() => {
                                if (!pageRendering) {
                                    canvasOffsetX = 0;
                                    canvasOffsetY = 0;
                                    renderPageQuiet(pageNum);
                                }
                            }, 100);
                        }

                        isPinching = false;
                        touchMoved = false;
                        initialDistance = 0;
                    }
                });

                // Remove mouse wheel navigation - zoom only
                document.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    if (e.ctrlKey || e.metaKey) {
                        // Zoom with Ctrl+scroll
                        if (e.deltaY < 0) zoomIn();
                        else zoomOut();
                    }
                    // Remove page navigation on scroll
                }, { passive: false });
            } catch (error) {
                console.error('Error loading PDF:', error);
                console.error('PDF URL:', `/api/ebooklet/{{ ebooklet_id }}/pdf/`);
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                document.getElementById('errorMessage').textContent = `Error loading PDF: ${error.message}. Please check your connection and try again.`;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Handle window resize for mobile orientation changes
        let resizeTimeout;
        window.addEventListener('resize', () => {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(() => {
                if (pdfDoc && !pageRendering) {
                    renderPage(pageNum, false);
                }
            }, 250); // Wait for resize to complete
        });

        // Start loading the PDF
        initPDF();

        // Prevent right-click, drag, select, copy
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('dragstart', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
        document.addEventListener('copy', e => e.preventDefault());

        // Prevent F12, Ctrl+Shift+I, Ctrl+U
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
            }
        });
    </script>
</body>

</html>